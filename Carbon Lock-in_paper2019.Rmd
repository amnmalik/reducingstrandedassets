---
title: "Reducing Stranded Assets through Early action in the Indian Power Sector"
author: "Aman Malik and Christoph Bertram"
output: 
  html_document:
    theme: paper
    toc: true
    toc_float:
      collapsed: false
---

```{r global_settings, include=FALSE}
# setting global settings for knitr
# echo=TRUE/FALSE whether to include R source code in the output file
# knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.path = "figure-carbonlockin/", cache = T, echo = F, fig.retina = 1)
```

```{r req_packages,message=FALSE, warning=FALSE, include=FALSE,results='hide'}
library(quitte)
library(mrremind)
library(tidyverse)
library(reshape)
library(data.table)
library(RColorBrewer)
library(knitr)
library(mip)
library(readxl)
```

```{r input_data_file}
load("data/data_IND2019_12_02.RData")
models <- inline.data.frame(
  "model;                       model.name",
  "REMIND-MAgPIE 1.7-3.0;         REMIND",
  "WITCH2016;          WITCH",
  "AIM/Enduse 3.0;            AIM/Enduse",
  "IMAGE 3.0;     IMAGE",
  "POLES CDL;   POLES",
  "AIM V2.1; AIM",
  "India MARKAL; India MARKAL",
  "GEM-E3; GEM_E3",
  NULL
)

## Renaming model names
whole <- whole %>%
  replace_column(models, model, model.name) %>%
  filter(scen_name %in% c("Delayed action","Early action")) %>% 
  order.levels(scen_name = c("Delayed action", "Early action")) %>%
  removeColNa() %>%
  order.levels(model = c("AIM", "IMAGE", "POLES", "GEM_E3", "REMIND", "WITCH", "AIM/Enduse", "India MARKAL"))
```

### Corrections to AIM/Enduse data

```{r AIM_Enduse_coal_capacity,warning=FALSE,fig.show='hold'}

# Changing AIM/Enduse values for Capacity|Solar
whole[whole$model == "AIM/Enduse" & whole$variable == "Capacity|Electricity|Solar", ]$value <- whole[whole$model == "AIM/Enduse" & whole$variable == "Capacity|Electricity|Solar", ]$value + whole[whole$model == "AIM/Enduse" & whole$variable == "Capacity|Electricity|Storage", ]$value

```

```{r historical_data}
load("data/HistandBotmup.RData")

### historical data from various government sources: CEA reports, MNRE, NITI AAYOG
hist_IND <- readxl::read_excel("Data/Compiled_historical.xlsx")
hist_IND <- as.quitte(hist_IND)
```

```{r}
## Specific colours for the model names
myColors <- brewer.pal(8, name = "Dark2") # for unique colors on models
names(myColors) <- getModels(whole)
```


### Fig. 1: Power generation from coal in 2030 Delayed action
```{r data_wrangling}

whole_se_elec_coal <- whole %>% filter(variable %in% c("Secondary Energy|Electricity|Coal|w/o CCS")) 


hist_se_elec_coal <- hist_and_botmup %>% filter(region=="IND", period %in% c(2005:2015),  variable=="SE|Electricity|Coal (EJ/yr)")


wholeCoal <- whole %>% 
  filter(variable %in% c("Secondary Energy|Electricity|Coal|w/o CCS")) %>% 
  select(model, scen_name,value, period) %>% 
  spread(scen_name, value = value) %>% 
  mutate(difference = `Early action` - `Delayed action`) %>% 
  gather(3:5,key = "scen_name",value = "value") %>% 
  mutate(scen_name = factor(scen_name,levels = c("Delayed action","Early action","difference"))) %>% 
  mutate(model_scope = if_else(model %in% c("AIM/Enduse", "India MARKAL"),"national","global"))



whole_se_elec_coal_global <- whole_se_elec_coal%>% 
  filter(period<2051,scen_name=="Delayed action",model!="GEM_E3") %>% 
  group_by(period,model_scope) %>% 
  summarise(minimum=min(value)*277.78,maximum=max(value)*277.78)

```

```{r plotting}
p <- ggplot() +
  ### grey lines
  geom_line(data = wholeCoal %>% filter(period %in% c(2010:2030), scen_name == "Delayed action", model_scope == "global"), aes(x = period, y = value * 277.78, group = interaction(model, scen_name)), size = 0.1, color = "grey", show.legend = F) +
  ## grey ribbon
  geom_ribbon(whole_se_elec_coal_global %>% filter(period %in% c(2010:2030), model_scope == "global"),
    mapping = aes(x = period, ymin = minimum, ymax = maximum, fill = model_scope), alpha = 0.5, fill = "grey", show.legend = F
  )+
  ## national models dashed line
  geom_line(data = wholeCoal %>% filter(period %in% c(2010:2030), scen_name == "Delayed action", model_scope == "national"), aes(x = period, y = value * 277.78, group = interaction(model, scen_name), color = model), linetype = 2, size = 1.5)+
  # Govt. projections
  geom_point(hist_IND %>% filter(variable == "Secondary Energy|Electricity|Coal", model %in% c("CEA_NEP", "IESS", "IEM", "CEA_OPT")), mapping = aes(x = period, y = value * 0.001, shape = model),color="blue")+
  # Govt. historical
  geom_point(hist_IND %>% filter(variable == "Secondary Energy|Electricity|Coal", model == "CEA_growth"), mapping = aes(x = period, y = value * 0.001, size = scenario))+  
  ## Model names on right in light grey
  geom_text(wholeCoal %>% filter(period == 2030, scen_name == "Delayed action", model_scope == "global") %>% mutate(short_name = substring(model, 1, 1)), mapping = aes(x = 2030.5, y = value * 277.78, label = short_name, fontface = "bold"), color = "grey", size = 3)+
    scale_size_manual(values = c(1.5, 2.5)) +
  labs(
    y = "Power generation from coal w/o CCS (TWh)",
    size = ""
  ) +
  scale_colour_manual(values = myColors, limits = c("AIM/Enduse", "India MARKAL")) +
  theme_bw()+
  theme(
    axis.title = element_text(size = 12), 
    axis.text = element_text(size = 10),
    axis.title.x = element_blank(),
    strip.text.x = element_text(size = 8), 
    axis.text.x = element_text(angle = 90, hjust = 1)
  )
```

### Fig. 2: Power generation from solar and wind in 2030 in Delayed action
```{r solar_wind,message=FALSE,warning=FALSE}

## Solar 
whole_se_solar <- whole %>% filter(variable %in% c("Secondary Energy|Electricity|Solar" ))

whole_se_solar_global <- whole_se_solar%>% 
  filter(period<2051,model_scope=="global",scen_name=="Delayed action",model!="GEM_E3") %>% 
  group_by(period) %>% 
  summarise(minimum=min(value)*277.78,maximum=max(value)*277.78)


q <- ggplot()+
  ## Grey lines
  geom_line(data = whole_se_solar %>% filter(period %in% c(2010:2030),scen_name=="Delayed action",model_scope=="global"), mapping = aes(x=period,y=value*277.78,group=interaction(model,scen_name)),size=0.1,color="grey")+
  ## Grey ribbons
  geom_ribbon(whole_se_solar_global %>% filter(period %in% c(2010:2030)),mapping = aes(x =period,ymin = minimum,ymax=maximum), alpha = 0.4,fill="grey")+
  ## national models colored dashed
  geom_line(data = whole_se_solar %>% filter(period %in% c(2010:2030),scen_name=="Delayed action",model_scope=="national"), aes(x=period,y=value*277.78,group=interaction(model,scen_name),color=model),size=1.5,linetype=2)+
  ## historical and projections
  geom_point(hist_IND %>% filter(variable=="Secondary Energy|Electricity|Solar",model %in% c("CEA_MON","CEA_ANNUAL","CEA_NEP","Prayas"),period %in% c(2010:2027)),mapping = aes(x=period,y=value,shape=scenario))+
 ## Grey model names on right
  geom_text(whole_se_solar %>% filter(period ==2030,scen_name=="Delayed action",model_scope=="global") %>% mutate (short_name= substring(model,1,1)) ,mapping = aes(x=2030.5,y=value*277.78,label=short_name,fontface="bold"),color="grey",size=3.5)+
  coord_cartesian(ylim=c(0,460))+
    labs(
    y = "Power generation from solar (TWh)"
    )+
     scale_colour_manual(values=myColors, limits = c("AIM/Enduse", "India MARKAL"))+
  theme_bw()+
  theme(axis.title=element_text(size=14),
        axis.text = element_text(size=14),
        axis.title.x=element_blank())

q
##### Wind

whole_se_wind<- whole %>% filter(variable %in% c("Secondary Energy|Electricity|Wind" ))

whole_se_wind_global <- whole_se_wind%>% 
  filter(period<2051,model_scope=="global",scen_name=="Delayed action",model!="GEM_E3") %>% 
  group_by(period) %>% 
  summarise(minimum=min(value)*277.78,maximum=max(value)*277.78)


r <- ggplot()+
  ## Grey lines
  geom_line(data = whole_se_wind %>% filter(period %in% c(2010:2030),scen_name=="Delayed action",model_scope=="global"), mapping = aes(x=period,y=value*277.78,group=interaction(model,scen_name)),size=0.1,color="grey")+
  ## Grey ribbons
  geom_ribbon(whole_se_wind_global %>% filter(period %in% c(2010:2030)),mapping = aes(x =period,ymin = minimum,ymax=maximum), alpha = 0.4,fill="grey")+
  ## national models colored dashed
  geom_line(data = whole_se_wind %>% filter(period %in% c(2010:2030),scen_name=="Delayed action",model_scope=="national"), aes(x=period,y=value*277.78,group=interaction(model,scen_name),color=model),size=1.5,linetype=2)+
  ## historical and projections
  geom_point(hist_IND %>% filter(variable=="Secondary Energy|Electricity|Wind",model %in% c("CEA_MON","CEA_ANNUAL","CEA_NEP","Prayas"),period %in% c(2010:2027)),mapping = aes(x=period,y=value,shape=scenario))+
 ## Grey model names on right
  geom_text(whole_se_wind %>% filter(period ==2030,scen_name=="Delayed action",model_scope=="global") %>% mutate (short_name= substring(model,1,1)) ,mapping = aes(x=2030.5,y=value*277.78,label=short_name,fontface="bold"),color="grey",size=3.5)+
  coord_cartesian(ylim=c(0,460))+
    labs(
    y = "Power generation from Wind (TWh)"
    )+
     scale_colour_manual(values=myColors, limits = c("AIM/Enduse", "India MARKAL"))+
  theme_bw()+
  theme(axis.title=element_text(size=14),
        axis.text = element_text(size=14),
        axis.title.x=element_blank())

r

```


### Fig. 3: Power generation from gas in 2030 in Delayed action
```{r}
whole_se_gas <- whole %>% filter(variable %in% c("Secondary Energy|Electricity|Gas" ))

whole_se_gas_global <- whole_se_gas%>% 
  filter(period<2051,model_scope=="global",scen_name=="Delayed action") %>% 
  group_by(period) %>% 
  summarise(minimum=min(value)*277.78,maximum=max(value)*277.78)


t <- ggplot()+
  ## Grey lines
  geom_line(data = whole_se_gas %>% filter(period %in% c(2010:2030),scen_name=="Delayed action",model_scope=="global"), mapping = aes(x=period,y=value*277.78,group=interaction(model,scen_name)),size=0.1,color="grey")+
  ## Grey ribbons
  geom_ribbon(whole_se_gas_global %>% filter(period %in% c(2010:2030)),mapping = aes(x =period,ymin = minimum,ymax=maximum), alpha = 0.4,fill="grey")+
  ## national models colored dashed
  geom_line(data = whole_se_gas %>% filter(period %in% c(2010:2030),scen_name=="Delayed action",model_scope=="national"), aes(x=period,y=value*277.78,group=interaction(model,scen_name),color=model),size=1.5,linetype=2)+
  ## historical and projections
  geom_point(hist_IND %>% filter(variable=="Secondary Energy|Electricity|Gas",model %in% c("NITI AAYOG",
"CEA_NEP")),mapping = aes(x=period,y=value*0.001,shape=scenario))+
 ## Grey model names on right
  geom_text(whole_se_gas %>% filter(period ==2030,scen_name=="Delayed action",model_scope=="global") %>% mutate (short_name= substring(model,1,1)) ,mapping = aes(x=2030.5,y=value*277.78,label=short_name,fontface="bold"),color="grey",size=3.5)+
  coord_cartesian(ylim=c(0,800))+
    labs(
    y = "Power generation from Gas (TWh)"
    )+
     scale_colour_manual(values=myColors, limits = c("AIM/Enduse", "India MARKAL"))+
  theme_bw()+
  theme(axis.title=element_text(size=14),
        axis.text = element_text(size=14),
        axis.title.x=element_blank())

t
```


### Fig. 4: Coal capacity development: natural-retirement pathway and stranded capacity

#### Data wrangling

```{r data_input_ch2_part2}
## Rescaling Secondary energy and converting to capacity

whole_se_elec_coal <- whole %>%
  filter(variable %in% c("Secondary Energy|Electricity|Coal|w/o CCS"), period %in% c(2020:2070), !is.na(scen_name))

whole_se_elec_coal_2020 <- whole %>%
  filter(variable %in% c("Secondary Energy|Electricity|Coal|w/o CCS"), period == 2020, scen_name == "Early action")

models <- unique(whole_se_elec_coal$model)

# Normalising SE values to values in 2020
for (i in models) {
  whole_se_elec_coal[whole_se_elec_coal$model == i, ]$value <- whole_se_elec_coal[whole_se_elec_coal$model == i, ]$value /
    whole_se_elec_coal_2020[whole_se_elec_coal_2020$model == i, ]$value
}
# setting all model's 2020 SE to 2020 SE (2018 CEA values + some captive capacity :  986591 + 147035.84=1133 GWh)
whole_se_elec_coal[whole_se_elec_coal$period == 2020, ]$value <- 4.22

whole_se_elec_coal[whole_se_elec_coal$period != 2020, ]$value <- 4.22 * whole_se_elec_coal[whole_se_elec_coal$period != 2020, ]$value

whole_se_elec_coal$value <- whole_se_elec_coal$value * 277777.778 # EJ to GWh
# converting SE to capacity using current capacity factor
whole_se_elec_coal$value <- whole_se_elec_coal$value / (8760 * 0.59) # GWh to GW using capacity factor in 2018

whole_coal_cap_resc <- whole_se_elec_coal
```

```{r data_input_ch2_part3}
#### Stranding capacity for early and delay scenarios

modelnames <- as.character(unique(whole_se_elec_coal$model))
df <- fread("Data/remaining_delay.csv", header = T)
df <- df %>% gather(2:41, key = "age", value = "capacity")
df$age <- as.numeric(df$age)
df$period <- 2030

df.REMIND <- df %>% filter(model == "REMIND")
shite.2 <- df.REMIND
for (i in 1:40) {
  df.blah <- df.REMIND %>%
    mutate(capacity = lag(capacity, i, order_by = age)) %>%
    mutate(period = period + i)
  shite.2 <- bind_rows(shite.2, df.blah)
}
shite.2 <- shite.2 %>%
  mutate(age_group = ifelse(age < 10, "0-9", ifelse(age >= 10 & age < 20, "10-19", ifelse(age >= 20 & age < 30, "20-29", ifelse(age >= 30 & age <= 40, "30-39", "NA")))))


shite.2$age_group <- factor(shite.2$age_group, levels = c("30-39", "20-29", "10-19", "0-9"))
shite.2[is.na(shite.2)] <- 0
# finding age group of stranded capacity
shite.2.try <- shite.2 %>%
  group_by(model, period, age_group) %>%
  summarise(vals = sum(capacity))
stranded <- data.frame(model = character(0), period = numeric(0), age_group = character(0), vals = numeric(0))
model.data <- whole_se_elec_coal %>%
  filter(period %in% c(2030:2060), scen_name == "Delayed action", model == "REMIND") %>%
  select(1, 6, 10)

# interpolate model data
model.data <- interpolate_missing_periods(model.data, seq(2030, 2050, 1))
ages <- unique(shite.2$age_group)
for (i in seq(2030, 2050, 1)) {
  if (model.data[model.data$period == i, ]$value < shite.2.try[shite.2.try$age_group == "0-9" & shite.2.try$period == i, ]$vals & shite.2.try[shite.2.try$age_group == ages[1] & shite.2.try$period == i, ]$vals != 0) {
    stranded <- bind_rows(stranded, data.frame(model = "REMIND", period = i, age_group = ages[1], vals = shite.2.try[shite.2.try$age_group == "0-9" & shite.2.try$period == i, ]$vals - model.data[model.data$period == i, ]$value), shite.2.try %>% filter(age_group != j & period == i))
  } else if (model.data[model.data$period == i, ]$value < sum(shite.2.try[shite.2.try$age_group %in% ages[1:2] & shite.2.try$period == i, ]$vals) & shite.2.try[shite.2.try$age_group == ages[2] & shite.2.try$period == i, ]$vals != 0) {
    stranded <- bind_rows(stranded, data.frame(model = "REMIND", period = i, age_group = ages[2], vals = as.numeric(shite.2.try %>% filter(period == i, age_group %in% ages[1:2]) %>% group_by(period) %>% summarise(vals = sum(vals)))[2] - model.data[model.data$period == i, ]$value), shite.2.try %>% filter(age_group %in% ages[3:4] & period == i))
  } else if (model.data[model.data$period == i, ]$value < sum(shite.2.try[shite.2.try$age_group %in% ages[1:3] & shite.2.try$period == i, ]$vals) & shite.2.try[shite.2.try$age_group == ages[3] & shite.2.try$period == i, ]$vals != 0) {
    stranded <- bind_rows(stranded, data.frame(model = "REMIND", period = i, age_group = ages[3], vals = sum(shite.2.try[shite.2.try$age_group %in% ages[1:3] & shite.2.try$period == i, ]$vals) - model.data[model.data$period == i, ]$value), shite.2.try %>% filter(age_group %in% ages[4] & period == i))
  } else if (model.data[model.data$period == i, ]$value < sum(shite.2.try[shite.2.try$age_group %in% ages[1:4] & shite.2.try$period == i, ]$vals) & shite.2.try[shite.2.try$age_group == ages[4] & shite.2.try$period == i, ]$vals != 0) {
    stranded <- bind_rows(stranded, data.frame(model = "REMIND", period = i, age_group = ages[4], vals = sum(shite.2.try[shite.2.try$age_group %in% ages[1:4] & shite.2.try$period == i, ]$vals) - model.data[model.data$period == i, ]$value))
  } else if (model.data[model.data$period == i, ]$value > sum(shite.2.try[shite.2.try$age_group %in% ages[1:4] & shite.2.try$period == i, ]$vals)) {
    stranded <- bind_rows(stranded, data.frame(model = "REMIND", period = i, age_group = ages[4], vals = 0))
  }
}
##################################################

###### Early action
df <- fread("Data/remaining_early.csv", header = T)
# df$model <- modelnames[-5]
df <- df %>% select(1:41)
# assuming all plants older than 40 years are retired in 2020
df <- df %>% gather(2:41, key = "age", value = "capacity")
df$age <- as.numeric(df$age)

df.REMIND <- df %>% filter(model == "REMIND")
df.REMIND$period <- 2020

shite <- df.REMIND
for (i in 1:40) {
  df.blah <- df.REMIND %>%
    mutate(capacity = lag(capacity, i, order_by = age)) %>%
    mutate(period = period + i)
  shite <- bind_rows(shite, df.blah)
}
shite <- shite %>%
  mutate(age_group = ifelse(age < 10, "0-9", ifelse(age >= 10 & age < 20, "10-19", ifelse(age >= 20 & age < 30, "20-29", ifelse(age >= 30 & age < 40, "30-39", "NA")))))


shite$age_group <- factor(shite$age_group, levels = c("30-39", "20-29", "10-19", "0-9"))
```

```{r data_input_ch2_part4}
indian_coal <- read_excel("Data/india_coal_2.xlsx")
ic <- indian_coal %>%
  gather(2:54, value = "value", key = "period")
colnames(ic)[1] <- "category"
ic$model <- "CEA"
ic$period <- as.integer(ic$period)
ic$scen_name <- "Projections"


# Data from Global Energy Monitor
input.data <-
  read_excel("C:/Users/amalik/Owncloud/PhD/DISS/carbon lock-ins/Data/Coal_Swarm_INDIA.xlsx")

input.data <- input.data %>%
  gather(key = "Year", value = "Status", 4:8) %>%
  filter(Status != "XXX")

input.data$Status <-
  gsub("Pre|Perm|Ann", replacement = "Planned", input.data$Status)
input.data$Status <-
  gsub("She|Can", replacement = "Cancelled", input.data$Status)
input.data$Status <-
  gsub("Oper", replacement = "Operating", input.data$Status)
input.data$Status <-
  gsub("Ret", replacement = "Retired", input.data$Status)
input.data$Status <-
  gsub("Con", replacement = "Construction", input.data$Status)

input.data.2 <-
  input.data %>%
  group_by(Year, Status) %>%
  summarise(sum = sum(Capacity))
input.data.2 <- data.frame(input.data.2)
input.data.2$Year <- as.numeric(input.data.2$Year)

# Historical capacity
hist_IND <- readxl::read_excel("Data/Compiled_historical.xlsx")
hist_IND <- as.quitte(hist_IND)
```

#### Figures

```{r}
strandDelayed <- ggplot() +
  geom_bar(shite.2, mapping = aes(x = period, y = capacity, fill = age_group), stat = "identity") +
  geom_line(data = whole_se_elec_coal %>% filter(period %in% c(2020:2060), scen_name == "Delayed action", model == "REMIND"), aes(x = period, y = value)) +
  scale_fill_manual(values = brewer.pal(n = 4, name = "YlOrRd")) +
  labs(
    x = "Year",
    y = "Coal Capacity (GW)",
    subtitle = "Delayed action-REMIND"
  ) +
  coord_cartesian(ylim = c(0, 340)) +
  theme_bw()+
  theme(axis.text = element_text(size = 10), axis.title.x = element_blank())

strandEarly <- ggplot() +
  geom_bar(shite, mapping = aes(x = period, y = capacity, fill = age_group), stat = "identity") +
  geom_line(data = whole_se_elec_coal %>% filter(period %in% c(2020:2060), scen_name == "Early action", model == "REMIND"), aes(x = period, y = value, group = interaction(model, scen_name))) +
  labs(
    x = "Year",
    y = "Coal Capacity (GW)",
    subtitle = "Early action-REMIND"
  ) +
  scale_fill_manual(values = brewer.pal(n = 4, name = "YlOrRd")) +
  coord_cartesian(ylim = c(0, 340)) +
  theme_bw()+
  theme(axis.text = element_text(size = 10), axis.title.x = element_blank())

strandDelayed
strandEarly
```

### Fig. 5: Power generation mix in 2030, early and delayed action and the difference



### Fig. Secondary Energy Hydro
```{r}
whole_sec_elec_hydro <- whole %>% filter(variable %in% c("Secondary Energy|Electricity|Hydro")) 

ggplot()+
  geom_line(data = whole_sec_elec_hydro %>% filter(period %in% c(2005:2030),scen_name=="Delayed action"), aes(x=period,y=value*277.78,group=interaction(model,scen_name),color=model,linetype=model_scope,size=model_scope))+
# facet_grid(scen_name~.)+
 labs(
    x = "Year",
    y = "Power generation from Hydro (TWh)"
    )+ theme(strip.text.x = element_text(angle = 90,size = 8),axis.text.x = element_text(angle = 90, hjust = 1))+
     geom_point(hist_IND %>% group_by(model,variable) %>% filter(variable=="Secondary Energy|Electricity|Hydro", model %in% c("CEA_NEP","OWN"), period%in%c(2005:2027)),mapping = aes(x=period, y= value*0.001,shape=scenario))+
  scale_size_manual(values=c(1, 1.5))+theme_bw()+
  scale_colour_manual(values=myColors)
``````
